<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restaurant Staff Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['DM Sans', 'sans-serif'],
          }
        }
      }
    }
  </script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
    
    .card-hover {
      transition: all 0.2s ease;
    }
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .sidebar-item {
      transition: all 0.2s ease;
    }
    .sidebar-item:hover {
      background: linear-gradient(90deg, rgba(237, 122, 18, 0.1) 0%, transparent 100%);
    }
    .sidebar-item.active {
      background: linear-gradient(90deg, rgba(237, 122, 18, 0.15) 0%, transparent 100%);
      border-left: 3px solid #ed7a12;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #ed7a12 0%, #de5f08 100%);
      transition: all 0.2s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(237, 122, 18, 0.4);
    }
    
    .floating-btn {
      box-shadow: 0 4px 20px rgba(237, 122, 18, 0.4);
      transition: all 0.3s ease;
    }
    .floating-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 25px rgba(237, 122, 18, 0.5);
    }
    
    .notification-dot {
      animation: pulse 2s infinite;
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full bg-gray-50 font-sans">
  <div id="app" class="h-full flex flex-col"><!-- Header -->
   <header id="main-header" class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm">
    <div class="flex items-center justify-between px-4 py-3 lg:px-6">
     <div class="flex items-center gap-3"><button id="menu-toggle" class="lg:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors">
       <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
       </svg></button>
      <div class="flex items-center gap-2">
       <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl flex items-center justify-center"><span class="text-white text-xl">üçΩÔ∏è</span>
       </div>
       <div class="hidden sm:block">
        <h1 id="hotel-name-display" class="font-bold text-gray-900">Grand Hotel</h1>
        <p class="text-xs text-gray-500">Restaurant Dashboard</p>
       </div>
      </div>
     </div>
     <div class="flex items-center gap-2 sm:gap-4"><button id="notification-btn" onclick="goToKitchenNotifications()" class="relative p-2 rounded-lg hover:bg-gray-100 transition-colors">
       <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
       </svg><span id="notification-count" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center notification-dot">0</span> </button>
      <div class="flex items-center gap-2 pl-2 sm:pl-4 border-l border-gray-200">
       <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center"><span class="text-orange-600 font-semibold text-sm" id="staff-initial">S</span>
       </div><span id="staff-name-display" class="hidden sm:block text-sm font-medium text-gray-700">Staff</span> <button id="profile-btn" onclick="openProfileView()" class="p-2 rounded-lg hover:bg-orange-50 text-gray-500 hover:text-orange-600 transition-colors" title="Profile">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg></button> <button id="logout-btn" class="p-2 rounded-lg hover:bg-red-50 text-gray-500 hover:text-red-600 transition-colors" title="Logout">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg></button>
      </div>
     </div>
    </div>
   </header>
   <div class="flex flex-1 overflow-hidden"><!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 lg:hidden hidden"></div><!-- Sidebar -->
    <aside id="sidebar" class="fixed lg:static inset-y-0 left-0 z-40 w-64 bg-white border-r border-gray-200 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
     <div class="flex-1 overflow-y-auto py-4">
      <nav class="px-3 space-y-1">
  <!-- Home (Admin only) -->
  <button class="sidebar-item admin-only w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left active" data-section="home">
    <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-3m0 0l7-4 7 4M5 9v10a1 1 0 001 1h12a1 1 0 001-1V9m-9 11l4-4m0 0l4 4m-4-4v4" />
    </svg>
    <span class="font-medium text-gray-700">Home</span>
  </button>

  <!-- Kitchen Management (Kitchen only) -->
  <button class="sidebar-item kitchen-only w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="kitchen">
    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
    </svg>
    <span class="font-medium text-gray-700">Kitchen Management</span>
    <span id="kitchen-sidebar-badge" class="ml-auto bg-red-100 text-red-600 text-xs font-semibold px-2 py-0.5 rounded-full">0</span>
  </button>

  <!-- Orders (Admin only) -->
  <button class="sidebar-item admin-only w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="orders">
    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    <span class="font-medium text-gray-700">Orders</span>
    <span id="orders-sidebar-badge" class="ml-auto bg-orange-100 text-orange-600 text-xs font-semibold px-2 py-0.5 rounded-full">0</span>
  </button>

  <!-- Menu Management (Admin only) -->
  <button class="sidebar-item admin-only w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="menu">
    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
    </svg>
    <span class="font-medium text-gray-700">Menu Management</span>
  </button>

  <!-- Analytics (Admin only) -->
  <button class="sidebar-item admin-only w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="analytics">
    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
    </svg>
    <span class="font-medium text-gray-700">Analytics</span>
  </button>

  <!-- Payment (Admin only) -->
  <button class="sidebar-item admin-only w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left" data-section="payment">
    <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
    </svg>
    <span class="font-medium text-gray-700">Payment / Subscription</span>
  </button>
</nav>

     </div>
     <div class="p-4 border-t border-gray-200">
      <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-xl p-4">
       <div class="flex items-center gap-3 mb-3">
        <svg class="w-8 h-8" viewbox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><defs>
          <style>
                    .hexagon-border { stroke: #ed7a12; stroke-width: 3; fill: none; }
                    .hexagon-fill { fill: #fed7aa; }
                  </style>
         </defs> <polygon points="50,10 90,35 90,85 50,110 10,85 10,35" class="hexagon-fill" /> <polygon points="50,10 90,35 90,85 50,110 10,85 10,35" class="hexagon-border" />
        </svg><span class="font-bold text-gray-900 text-lg">HotelMenuPro</span>
       </div>
       <p class="text-xs text-gray-600">Professional restaurant management solution</p>
      </div>
     </div>
    </aside><!-- Main Content -->
 <main id="main-content" class="flex-1 overflow-y-auto p-4 lg:p-6"></main>

   <!-- Toast Container -->
   <div id="toast-container" class="fixed top-20 right-4 z-50 space-y-2"></div><!-- Modal Container -->
   <div id="modal-container"></div>
  </div>


<script type="module">
  
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import {
  getFirestore,
  doc,
  getDoc,
  collection,
  query,
  orderBy,
  onSnapshot,
  updateDoc,
  deleteDoc,
  addDoc,
  serverTimestamp,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";





  const firebaseConfig = {
    apiKey: "AIzaSyAqB7NXuoL7l01X5t3cg-gdZJS1pFRrhjg",
    authDomain: "hotelmenupro.firebaseapp.com",
    projectId: "hotelmenupro",
    appId: "1:638142341064:web:ba85fdc6fc455d8aadeafd"
  };

  window.app = initializeApp(firebaseConfig);
  window.auth = getAuth(window.app);
  window.db = getFirestore(window.app);
 window.kitchenUnsub = null;
window.latestKitchenOrders = [];
// ‚úÖ Create order into Firestore
window.createOrderFS = async function createOrderFS(orderData) {
  try {
    const ref = await addDoc(collection(window.db, "orders"), {
      ...orderData,
      createdAt: serverTimestamp(), // ‚úÖ Firestore timestamp
    });
    console.log("‚úÖ Firestore order created:", ref.id);
    return ref.id;
  } catch (e) {
    console.error("‚ùå createOrderFS:", e);
    alert("Failed to create order. Check console.");
    return null;
  }
};

// ‚úÖ Confirm order from Kitchen (Firestore)
window.confirmKitchenOrder = async function confirmKitchenOrder(orderId) {
  try {
    const orderRef = doc(window.db, "orders", orderId);

    await updateDoc(orderRef, {
      status: "confirmed",
      confirmedAt: new Date().toISOString()
    });

    console.log("‚úÖ Order confirmed:", orderId);
  } catch (error) {
    console.error("‚ùå Failed to confirm order:", error);
    alert("Failed to confirm order. Check console.");
  }
};

window.completeOrderFS = async function(orderId) {
  try {
    const orderRef = doc(window.db, "orders", orderId);
    await updateDoc(orderRef, {
      status: "completed",
      completedAt: new Date().toISOString()
    });
  } catch (e) {
    console.error("‚ùå completeOrderFS:", e);
    alert("Failed to complete order. Check console.");
  }
};

window.deleteOrderFS = async function(orderId) {
  try {
    const orderRef = doc(window.db, "orders", orderId);
    await deleteDoc(orderRef);
  } catch (e) {
    console.error("‚ùå deleteOrderFS:", e);
    alert("Failed to delete order. Check console.");
  }
};



window.startKitchenListener = function startKitchenListener() {
  // ‚úÖ Prevent multiple listeners
  if (window.kitchenUnsub) return;

  const ordersRef = collection(window.db, "orders");
  const q = query(ordersRef, orderBy("createdAt", "desc"));
 // (no orderBy for safety)

  window.kitchenUnsub = onSnapshot(q, (snapshot) => {
    const orders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

    // ‚úÖ store latest orders for admin + kitchen
    window.latestKitchenOrders = orders;

    // ‚úÖ update badge counts
    const pendingCount = orders.filter(o => (o.status || "").toLowerCase() === "pending").length;
const confirmedCount = orders.filter(o => (o.status || "").toLowerCase() === "confirmed").length;

const kitchenBadge = document.getElementById("kitchen-sidebar-badge");
const notif = document.getElementById("notification-count");
const ordersBadge = document.getElementById("orders-sidebar-badge");

if (kitchenBadge) kitchenBadge.textContent = pendingCount;
if (notif) notif.textContent = pendingCount;
if (ordersBadge) ordersBadge.textContent = confirmedCount;

// If dashboard home is open, update those numbers too
if (window.currentSection === "home") {
  const dk = document.getElementById("dashboard-kitchen-count");
  const doo = document.getElementById("dashboard-orders-count");
  if (dk) dk.textContent = `${pendingCount} pending`;
  if (doo) doo.textContent = `${confirmedCount} confirmed`;
}


    // ‚úÖ render ONLY if currently inside kitchen section
    // ‚úÖ render kitchen if open
if (window.currentSection === "kitchen") {
  try {
    renderKitchenOrdersFromFirestore(orders);
  } catch (e) {
    console.error("‚ùå Render kitchen failed:", e, orders);
  }
}

// ‚úÖ render orders if open
if (window.currentSection === "orders") {
  try {
    window.renderOrdersMoreSection(document.getElementById("main-content"));

  } catch (e) {
    console.error("‚ùå Render orders failed:", e, orders);
  }
}



  }, (err) => {
    console.error("‚ùå Kitchen listener error:", err);
  });
};
;

  // ‚úÖ Step 3: Render Firestore orders into Kitchen UI
function safeJsonParse(str) {
  try { return JSON.parse(str); } catch { return null; }
}

function normalizeItems(order) {
  // 1) If items is already an array [{name, qty}] (your newer format)
  if (Array.isArray(order.items)) {
    return order.items.map(i => ({
      name: i.name ?? "Item",
      qty: i.qty ?? i.quantity ?? 1,
      price: i.price ?? null
    }));
  }

  // 2) If itemDetails exists (your dataSdk format: JSON string)
  if (typeof order.itemDetails === "string") {
    const parsed = safeJsonParse(order.itemDetails);
    if (Array.isArray(parsed)) {
      return parsed.map(i => ({
        name: i.name ?? "Item",
        qty: i.qty ?? i.quantity ?? 1,
        price: i.price ?? null
      }));
    }
  }

  // 3) If items is a string like "2x Pizza, 1x Coke"
  if (typeof order.items === "string" && order.items.trim()) {
    return order.items.split(",").map(s => ({
      name: s.trim(),
      qty: 1,
      price: null
    }));
  }

  return [];
}

function normalizeTotal(order) {
  const total =
    order.total ??
    order.totalAmount ??
    order.totalPrice ??
    order.totalprice ??
    0;

  const n = Number(total);
  return Number.isFinite(n) ? n : 0;
}

function getCustomerName(order) {
  return order.name || order.guestName || "No Name";
}

function getRoom(order) {
  return order.roomNumber || order.room || order.roomNo || "-";
}

function renderKitchenOrdersFromFirestore(orders) {
  const container = document.getElementById("kitchen-orders");
  if (!container) return;

  const pending = (orders || []).filter(o => (o.status || "").toLowerCase() === "pending");

  if (pending.length === 0) {
    container.innerHTML = `
      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-10 text-center">
        <h3 class="text-lg font-semibold text-gray-900">No pending orders</h3>
        <p class="text-gray-500 text-sm mt-1">Orders from menu will appear here</p>
      </div>
    `;
    return;
  }

  // (Optional) sort newest first if createdAt exists
  pending.sort((a, b) => {
  const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
  const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
  return tb - ta;
});


  container.innerHTML = pending.map(order => {
    const items = normalizeItems(order);
    const total = normalizeTotal(order);

    const itemsHtml = items.length
      ? `<ul class="ml-5 list-disc text-sm text-gray-700">
          ${items.map(i => `<li>${i.name} √ó ${i.qty}</li>`).join("")}
        </ul>`
      : `<p class="text-sm text-gray-600">No items</p>`;

    return `
      <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex items-start justify-between mb-2">
          <div>
            <h3 class="font-bold text-gray-900">${getCustomerName(order)}</h3>
            <p class="text-sm text-gray-600">Room ${getRoom(order)}</p>
            ${order.contact ? `<p class="text-xs text-gray-500">${order.contact}</p>` : ""}
          </div>
          <span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
            Pending
          </span>
        </div>

        ${itemsHtml}

        <p class="text-sm text-gray-600 mt-2"><b>Note:</b> ${order.note || order.specialInstructions || "None"}</p>

        <p class="text-sm mt-2 font-semibold text-orange-600">
          Total: ‚Çπ${total.toFixed(2)}
        </p>
        <button
  onclick="confirmKitchenOrder('${order.id}')"
  class="mt-3 w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded-lg transition"
>
  ‚úÖ Confirm Order
</button>
      </div>
    `;
  }).join("");
}
window.renderKitchenOrdersFromFirestore = renderKitchenOrdersFromFirestore;

// ‚úÖ Make helpers accessible globally (FIX for module-scope issue)
window.normalizeItems = normalizeItems;
window.normalizeTotal = normalizeTotal;
window.getCustomerName = getCustomerName;
window.getRoom = getRoom;

// ‚úÖ Orders section renderer (GLOBAL)
window.renderOrdersMoreSection = function renderOrdersMoreSection(container) {
  const all = Array.isArray(window.latestKitchenOrders) ? window.latestKitchenOrders : [];

  const confirmed = all.filter(o => (o.status || "").toLowerCase() === "confirmed");
  const completed = all.filter(o => (o.status || "").toLowerCase() === "completed");

  // ‚úÖ If no orders at all, show clean empty state (no Confirmed/Completed headings)
  if (confirmed.length === 0 && completed.length === 0) {
    container.innerHTML = `
      <div class="animate-fade-in">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-10 text-center">
          <h3 class="text-lg font-semibold text-gray-900">No orders yet</h3>
          <p class="text-gray-500 text-sm mt-1">Confirmed / Completed orders will appear here</p>
        </div>
      </div>
    `;
    return;
  }

  container.innerHTML = `
    <div class="animate-fade-in">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Orders</h2>
      </div>

      <div class="space-y-6">
        ${confirmed.length ? `
          <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-4">
            <h3 class="font-bold text-gray-900 mb-3">‚úÖ Confirmed</h3>
            <div id="orders-confirmed-list" class="space-y-3"></div>
          </div>` : ""}

        ${completed.length ? `
          <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-4">
            <h3 class="font-bold text-gray-900 mb-3">üèÅ Completed</h3>
            <div id="orders-completed-list" class="space-y-3"></div>
          </div>` : ""}
      </div>
    </div>
  `;

  renderOrdersListFS("orders-confirmed-list", confirmed, "confirmed");
  renderOrdersListFS("orders-completed-list", completed, "completed");
};

// ‚úÖ Orders list renderer (GLOBAL, uses global helper functions)
function renderOrdersListFS(targetId, list, type) {
  const el = document.getElementById(targetId);
  if (!el) return;

  if (!list.length) {
    el.innerHTML = `<p class="text-sm text-gray-500">No ${type} orders</p>`;
    return;
  }

  list.sort((a, b) => {
    const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
    const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
    return tb - ta;
  });

  el.innerHTML = list.map(order => {
    const items = window.normalizeItems(order);
    const total = window.normalizeTotal(order);

    return `
      <div class="border border-gray-100 rounded-xl p-4 bg-gray-50">
        <div class="flex items-start justify-between">
          <div>
            <p class="font-semibold text-gray-900">${window.getCustomerName(order)}</p>
            <p class="text-sm text-gray-600">Room ${window.getRoom(order)}</p>
          </div>
          <span class="text-xs font-semibold px-2 py-1 rounded-full ${
            type === "confirmed"
              ? "bg-orange-100 text-orange-700"
              : "bg-green-100 text-green-700"
          }">
            ${type.toUpperCase()}
          </span>
        </div>

        <div class="mt-2">
          ${
            items.length
              ? `<ul class="ml-5 list-disc text-sm text-gray-700">
                  ${items.map(i => `<li>${i.name} √ó ${i.qty}</li>`).join("")}
                </ul>`
              : `<p class="text-sm text-gray-600">${order.items || "No items"}</p>`
          }
        </div>

        <p class="text-sm font-semibold text-orange-600 mt-2">Total: ‚Çπ${total.toFixed(2)}</p>

        <div class="mt-3 flex gap-2">
          <button
            onclick="openOrderDetailsFS('${order.id}')"
            class="flex-1 px-3 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-100 text-sm font-medium">
            View
          </button>

          ${
            type === "confirmed"
              ? `<button
                  onclick="completeOrderFS('${order.id}')"
                  class="flex-1 px-3 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white text-sm font-semibold">
                  Mark Complete
                </button>`
              : ""
          }

          <button
            onclick="deleteOrderFS('${order.id}')"
            class="px-3 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-semibold"
            title="Delete">
            üóëÔ∏è
          </button>
        </div>
      </div>
    `;
  }).join("");
}




  // üîê Protect dashboard
  onAuthStateChanged(window.auth, async (user) => {
  if (!user) {
    window.location.href = "../login/index.html";
    return;
  }

  // üîç Fetch role from Firestore
  const userRef = doc(window.db, "users", user.uid);
  const userSnap = await getDoc(userRef);

  if (!userSnap.exists()) {
    alert("No role assigned. Contact admin.");
    await signOut(window.auth);
    return;
  }

  const role = userSnap.data().role;
  window.currentUserRole = role;


window.currentUserRole = role;   // ‚úÖ very important

if (role === "admin") {
  enableAdminView();
  window.renderSection("home");

  // ‚úÖ IMPORTANT: admin also listens so kitchen page works
  window.startKitchenListener();
}


else if (role === "kitchen") {
  enableKitchenView();
  window.currentSection = "kitchen";
  window.renderSection("kitchen");      // ‚úÖ make sure kitchen UI exists first
  window.startKitchenListener(); // ‚úÖ then start listener
}

else {
  alert("Unauthorized role");
  await signOut(window.auth);
}

});


  // üö™ Logout
  window.logoutUser = () => {
    signOut(window.auth)
      .then(() => {
        window.location.href = "../login/index.html";

      })
      .catch((error) => {
        alert(error.message);
      });
  };

function enableAdminView() {
  document.querySelectorAll(".admin-only").forEach(el => el.style.display = "");
  document.querySelectorAll(".kitchen-only").forEach(el => el.style.display = "");
}

function enableKitchenView() {
  document.querySelectorAll(".admin-only").forEach(el => el.style.display = "none");
  document.querySelectorAll(".kitchen-only").forEach(el => el.style.display = "");

  // ‚úÖ auto-open kitchen
  setTimeout(() => {
    const kitchenBtn = document.querySelector('[data-section="kitchen"]');
    if (kitchenBtn) kitchenBtn.click();
  }, 200);


  // 1Ô∏è‚É£ Hide admin-only items
  document.querySelectorAll(".admin-only")
    .forEach(el => el.style.display = "none");

  // 2Ô∏è‚É£ Show kitchen-only items
  document.querySelectorAll(".kitchen-only")
    .forEach(el => el.style.display = "block");

  // 3Ô∏è‚É£ Force open Kitchen section
  setTimeout(() => {
  window.startKitchenListener();
}, 200);



  // üî• LISTEN TO FIRESTORE ORDERS (LIVE)
 
  
}

// ‚úÖ Step 3: Listen to Firestore orders collection
// ‚úÖ Listen to Firestore "orders" and render in kitchen UI

document.getElementById("logout-btn")?.addEventListener("click", window.logoutUser);



</script>



  <script>
    // Default configuration
    const defaultConfig = {
      hotel_name: 'Grand Hotel',
      staff_name: 'Staff',
      primary_color: '#ed7a12'
    };

    let config = { ...defaultConfig };
 window.currentSection = 'home';
    let allOrders = [];
    let allMenuItems = [];
    let fabOpen = false;
    let userProfile = {
      name: 'Staff',
      email: 'staff@grandhotel.com',
      picture: null
    };

    // Element SDK initialization
    function initElementSdk() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            applyConfig();
          },
          mapToCapabilities: (cfg) => ({
            recolorables: [
              {
                get: () => cfg.primary_color || defaultConfig.primary_color,
                set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
              }
            ],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (cfg) => new Map([
            ['hotel_name', cfg.hotel_name || defaultConfig.hotel_name],
            ['staff_name', cfg.staff_name || defaultConfig.staff_name]
          ])
        });
      }
    }

    const dataHandler = {
      onDataChanged(data) {
        // ‚úÖ Keep DataSDK for menu items only (Firestore is source of truth for orders)
allOrders = []; 

        allMenuItems = data.filter(d => d.type === 'menuItem');
        
        // Update orders badge
        const fsOrders = Array.isArray(window.latestKitchenOrders) ? window.latestKitchenOrders : [];
const confirmedOrders = fsOrders.filter(o => (o.status || "").toLowerCase() === "confirmed").length;
const pendingOrders = fsOrders.filter(o => (o.status || "").toLowerCase() === "pending").length;

document.getElementById('orders-sidebar-badge').textContent = confirmedOrders;
document.getElementById('kitchen-sidebar-badge').textContent = pendingOrders;
document.getElementById('notification-count').textContent = pendingOrders;

        
        window.renderSection(window.currentSection);

      }
    };

    // Initialize Data SDK
    async function initDataSdk() {
      if (window.dataSdk) {
        const result = await window.dataSdk.init(dataHandler);
        if (!result.isOk) {
          console.error('Failed to initialize Data SDK');
        }
      }
    }

    // Apply configuration
    function applyConfig() {
      const hotelName = config.hotel_name || defaultConfig.hotel_name;
      const staffName = config.staff_name || defaultConfig.staff_name;
      
      document.getElementById('hotel-name-display').textContent = hotelName;
      document.getElementById('staff-name-display').textContent = staffName;
      document.getElementById('staff-initial').textContent = staffName.charAt(0).toUpperCase();
    }

    // Sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('hidden');
    }

    document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);
    document.getElementById('sidebar-overlay').addEventListener('click', toggleSidebar);
    document.getElementById('logout-btn').addEventListener('click', () => {
     logoutUser();
    });

    // Section navigation
  // ‚úÖ Section navigation (FIXED)
document.querySelectorAll('.sidebar-item').forEach(item => {
  item.addEventListener('click', () => {
    const section = item.dataset.section;

    // ‚úÖ Restriction: kitchen user can open ONLY kitchen
    if (window.currentUserRole === "kitchen" && section !== "kitchen") {
      return;
    }

    // reset active UI
    document.querySelectorAll('.sidebar-item').forEach(btn => {
      btn.classList.remove('active');
      const svg = btn.querySelector('svg');
      if (svg) {
        svg.classList.remove('text-orange-500');
        svg.classList.add('text-gray-500');
      }
    });

    // apply active UI
    item.classList.add('active');
    const svg = item.querySelector('svg');
    if (svg) {
      svg.classList.remove('text-gray-500');
      svg.classList.add('text-orange-500');
    }

    window.currentSection = section;
window.renderSection(section);


    // close sidebar on mobile
    if (window.innerWidth < 1024) toggleSidebar();
  });
});



    // FAB toggle
    function toggleFab() {
      fabOpen = !fabOpen;
      const fabMenu = document.getElementById('fab-menu');
      const fabIcon = document.getElementById('fab-icon');
      
      fabMenu.classList.toggle('hidden', !fabOpen);
      fabIcon.style.transform = fabOpen ? 'rotate(45deg)' : 'rotate(0deg)';
    }

    function openQuickAction() {
      openAddOrderModal();
      toggleFab();
    }

    // Render section content
    // Render section content

// ‚úÖ PASTE renderSection ROUTER HERE (exact place)
window.renderSection = function renderSection(section) {
  const container = document.getElementById("main-content");
  if (!container) return;

  if (window.currentUserRole === "kitchen" && section !== "kitchen") {
    section = "kitchen";
  }

  window.currentSection = section;

  switch (section) {
    case "home":
      renderDashboardSection(container);
      break;

    case "kitchen":
  container.innerHTML = `
    <div class="animate-fade-in">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Kitchen Management</h2>
        <p class="text-gray-500 text-sm mt-1">Pending orders appear here</p>
      </div>
      <div id="kitchen-orders" class="space-y-4"></div>
    </div>
  `;

  // ‚úÖ if listener already fetched orders, show them instantly
  if (Array.isArray(window.latestKitchenOrders)) {
    window.renderKitchenOrdersFromFirestore(window.latestKitchenOrders);

  }

  break;


    case "orders":
      renderOrdersMoreSection(container);
      break;

    case "menu":
      renderMenuSection(container);
      break;

    case "analytics":
      renderAnalyticsSection(container);
      break;

    case "payment":
      renderPaymentSection(container);
      break;

    default:
      renderDashboardSection(container);
  }
};

    // Profile Section
    function renderProfileSection(container) {
      
      const profilePictureUrl = userProfile.picture || `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%23fed7aa' width='100' height='100'/%3E%3Ccircle cx='50' cy='35' r='20' fill='%23f59e0b'/%3E%3Cpath d='M30 70 Q50 55 70 70 L70 100 L30 100 Z' fill='%23f59e0b'/%3E%3C/svg%3E`;
      
      let html = `
        <div class="animate-fade-in admin-only">

          <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Profile</h2>
            <p class="text-gray-500 text-sm mt-1">Manage your profile information</p>
          </div>
          
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8">
            <div class="max-w-md mx-auto">
              <!-- Profile Picture -->
              <div class="mb-8 flex flex-col items-center">
                <div class="relative mb-4">
                  <img id="profilePictureDisplay" src="${profilePictureUrl}" alt="Profile Picture" class="w-32 h-32 rounded-full border-4 border-orange-200 object-cover"/>
                  <button type="button" onclick="openProfilePictureUpload()" class="absolute bottom-0 right-0 w-10 h-10 bg-orange-500 hover:bg-orange-600 text-white rounded-full flex items-center justify-center shadow-lg transition-colors" title="Change profile picture">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                  </button>
                </div>
                <p class="text-sm text-gray-600 text-center">Click the camera icon to change your profile picture</p>
              </div>
              
              <!-- Hidden File Input -->
              <input type="file" id="profilePictureInput" accept="image/" onchange="handleProfilePictureUpload(event)" class="hidden"/>
              
              <!-- Name Field -->
              <div class="mb-6">
                <label for="profileNameInput" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                <input id="profileNameInput" type="text" value="${userProfile.name}" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 font-medium" placeholder="Enter your full name"/>
              </div>
              
              <!-- Email Field (Read-only) -->
              <div class="mb-8">
                <label for="profileEmailInput" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                <input id="profileEmailInput" type="email" value="${userProfile.email}" readonly class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 cursor-not-allowed font-medium" placeholder="your.email@example.com"/>
                <p class="text-xs text-gray-500 mt-2">‚úì Email cannot be changed from this section</p>
              </div>
              
              <!-- Save Button -->
              <button type="button" onclick="saveProfileChanges()" class="btn-primary w-full px-6 py-3 rounded-xl text-white font-semibold flex items-center justify-center gap-2 transition-all hover:shadow-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Save Changes
              </button>
            </div>
          </div>
        </div>`;
      
      container.innerHTML = html;
    }

    function openProfilePictureUpload() {
      document.getElementById('profilePictureInput').click();
    }

    function handleProfilePictureUpload(event) {
      const file = event.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          userProfile.picture = e.target.result;
          document.getElementById('profilePictureDisplay').src = userProfile.picture;
          showToast('Profile picture updated! Click Save to confirm.', 'info');
        };
        reader.readAsDataURL(file);
      } else {
        showToast('Please select a valid image file', 'error');
      }
      event.target.value = '';
    }

    function saveProfileChanges() {
      const newName = document.getElementById('profileNameInput').value.trim();
      
      if (!newName) {
        showToast('Please enter a name', 'error');
        return;
      }
      
      userProfile.name = newName;
      
      // Update display across dashboard
      document.getElementById('staff-name-display').textContent = newName;
      document.getElementById('staff-initial').textContent = newName.charAt(0).toUpperCase();
      
      showToast('Profile updated successfully! ‚úì', 'success');
    }

    // Dashboard Section
    function renderDashboardSection(container) {
      let html = `
        <div class="animate-fade-in admin-only">

          <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Dashboard</h2>
            <p class="text-gray-500 text-sm mt-1">Welcome to your restaurant management hub</p>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <button onclick="navigateToSection('kitchen')" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 card-hover text-left hover:shadow-md transition-shadow">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-bold text-gray-900">Kitchen</h3>
                  <p id="dashboard-kitchen-count" class="text-sm text-red-600 font-semibold">0 pending</p>
                </div>
              </div>
              <p class="text-sm text-gray-600">Kitchen orders to prepare</p>
            </button>
            
            <button onclick="navigateToSection('orders')" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 card-hover text-left hover:shadow-md transition-shadow">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-bold text-gray-900">Orders</h3>
                  <p id="dashboard-orders-count" class="text-sm text-orange-600 font-semibold">0 confirmed</p>
                </div>
              </div>
              <p class="text-sm text-gray-600">Manage confirmed orders</p>
            </button>
            
            <button onclick="navigateToSection('menu')" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 card-hover text-left hover:shadow-md transition-shadow">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-bold text-gray-900">Menu</h3>
                  <p id="dashboard-menu-count" class="text-sm text-blue-600 font-semibold">0 items</p>
                </div>
              </div>
              <p class="text-sm text-gray-600">Add and manage menu items</p>
            </button>
            
            <button onclick="navigateToSection('analytics')" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 card-hover text-left hover:shadow-md transition-shadow">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-bold text-gray-900">Analytics</h3>
                  <p class="text-sm text-green-600 font-semibold">Performance</p>
                </div>
              </div>
              <p class="text-sm text-gray-600">View business insights</p>
            </button>
            
            <button onclick="navigateToSection('payment')" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 card-hover text-left hover:shadow-md transition-shadow">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-bold text-gray-900">Payment</h3>
                  <p class="text-sm text-purple-600 font-semibold">Subscription</p>
                </div>
              </div>
              <p class="text-sm text-gray-600">Manage billing</p>
            </button>
          </div>
        </div>`;
      
      container.innerHTML = html;
      
      // Update dashboard counts
      const confirmedOrders = allOrders.filter(o => o.status === 'confirmed').length;
      document.getElementById('dashboard-orders-count').textContent = confirmedOrders + ' confirmed';
      
      const kitchenOrders = allOrders.filter(o => o.status === 'pending').length;
      document.getElementById('dashboard-kitchen-count').textContent = kitchenOrders + ' pending';
      
      document.getElementById('dashboard-menu-count').textContent = allMenuItems.length + ' items';
    }

    function navigateToSection(section) {
      document.querySelectorAll('.sidebar-item').forEach(item => {
        if (item.dataset.section === section) {
          item.click();
        }
      });
    }

    function openProfileView() {
      renderProfileSection(document.getElementById('main-content'));
      window.scrollTo(0, 0);
    }

    function goToKitchenNotifications() {
      navigateToSection('kitchen');
    }

  
    function openKitchenDetails(orderId) {
      const order = allOrders.find(o => o.__backendId === orderId);
      if (!order) return;
      
      const itemDetails = order.itemDetails ? JSON.parse(order.itemDetails) : [];
      let totalPrice = 0;
      let detailsHtml = '';
      
      if (itemDetails.length > 0) {
        itemDetails.forEach(item => {
          const itemTotal = item.price * item.quantity;
          totalPrice += itemTotal;
          detailsHtml += `
            <div class="flex justify-between items-start py-2 border-b border-gray-100">
              <div>
                <p class="font-medium text-gray-900">${item.name}</p>
                <p class="text-xs text-gray-500">Qty: ${item.quantity}</p>
              </div>
              <div class="text-right">
                <p class="font-semibold text-gray-900">‚Çπ${itemTotal.toFixed(2)}</p>
                <p class="text-xs text-gray-500">‚Çπ${item.price}/unit</p>
              </div>
            </div>`;
        });
      } else {
        detailsHtml = `<p class="text-sm text-gray-600">${order.items}</p>`;
      }
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 w-full max-w-md animate-fade-in my-8">
          <div class="mb-4">
            <h2 class="text-xl font-bold text-gray-900 mb-2">${order.name} - Room ${order.roomNumber}</h2>
            <p class="text-sm text-gray-500">Order #${order.orderId}</p>
          </div>
          
          <div class="space-y-4 mb-6 max-h-[40vh] overflow-y-auto">
            <div>
              <h3 class="font-semibold text-gray-900 mb-3">Order Items</h3>
              <div class="space-y-2">
                ${detailsHtml}
              </div>
            </div>
            
            ${itemDetails.length > 0 ? `
              <div class="bg-orange-50 rounded-lg p-3 border border-orange-200">
                <div class="flex justify-between items-center">
                  <p class="font-semibold text-gray-900">Total Amount:</p>
                  <p class="text-lg font-bold text-orange-600">‚Çπ${totalPrice.toFixed(2)}</p>
                </div>
              </div>
            ` : ''}
            
            ${order.allergies ? `
              <div class="bg-red-50 rounded-lg p-3 border border-red-200">
                <p class="text-xs font-semibold text-red-700 mb-1">‚ö†Ô∏è ALLERGIES</p>
                <p class="text-sm text-red-600">${order.allergies}</p>
              </div>
            ` : ''}
            
            ${order.specialInstructions ? `
              <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                <p class="text-xs font-semibold text-yellow-700 mb-1">üìù SPECIAL INSTRUCTIONS</p>
                <p class="text-sm text-yellow-600">${order.specialInstructions}</p>
              </div>
            ` : ''}
          </div>
          
          <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
            <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 font-medium hover:bg-gray-200 transition-colors">
              Close
            </button>
            <button type="button" onclick="confirmKitchenOrder('${order.__backendId}'); closeModal();" class="px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white font-medium transition-colors">
              Start Cooking
            </button>
          </div>
        </div>`;
      document.getElementById('modal-container').appendChild(modal);
    }

    async function confirmKitchenOrderDataSdk(orderId) {
  if (!window.dataSdk) return;
  const order = allOrders.find(o => o.__backendId === orderId);
  if (!order) return;

  const result = await window.dataSdk.update({ ...order, status: 'confirmed' });

  if (result.isOk) {
    closeModal();
    showToast('Order sent to front office! ‚úì', 'success');
  } else {
    showToast('Failed to confirm order', 'error');
  }
}

    // Orders Section (Front Office)
    let ordersSearchQuery = '';
    



    function openOrderDetails(orderId) {
      const order = allOrders.find(o => o.__backendId === orderId);
      if (!order) return;
      
      const itemDetails = order.itemDetails ? JSON.parse(order.itemDetails) : [];
      let totalPrice = 0;
      let detailsHtml = '';
      
      if (itemDetails.length > 0) {
        itemDetails.forEach(item => {
          const itemTotal = item.price * item.quantity;
          totalPrice += itemTotal;
          detailsHtml += `
            <div class="flex justify-between items-start py-2 border-b border-gray-100">
              <div>
                <p class="font-medium text-gray-900">${item.name}</p>
                <p class="text-xs text-gray-500">Qty: ${item.quantity}</p>
              </div>
              <div class="text-right">
                <p class="font-semibold text-gray-900">‚Çπ${itemTotal.toFixed(2)}</p>
                <p class="text-xs text-gray-500">‚Çπ${item.price}/unit</p>
              </div>
            </div>`;
        });
      } else {
        detailsHtml = `<p class="text-sm text-gray-600">${order.items}</p>`;
      }
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 w-full max-w-md animate-fade-in my-8">
          <div class="mb-4">
            <h2 class="text-xl font-bold text-gray-900 mb-2">${order.guestName} - Room ${order.roomNumber}</h2>
            <p class="text-sm text-gray-500">Order #${order.orderId}</p>
          </div>
          
          <div class="space-y-4 mb-6 max-h-[40vh] overflow-y-auto">
            <div>
              <h3 class="font-semibold text-gray-900 mb-3">Order Items</h3>
              <div class="space-y-2">
                ${detailsHtml}
              </div>
            </div>
            
            ${itemDetails.length > 0 ? `
              <div class="bg-orange-50 rounded-lg p-3 border border-orange-200">
                <div class="flex justify-between items-center">
                  <p class="font-semibold text-gray-900">Total Amount:</p>
                  <p class="text-lg font-bold text-orange-600">‚Çπ${totalPrice.toFixed(2)}</p>
                </div>
              </div>
            ` : ''}
            
            ${order.allergies ? `
              <div class="bg-red-50 rounded-lg p-3 border border-red-200">
                <p class="text-xs font-semibold text-red-700 mb-1">‚ö†Ô∏è ALLERGIES</p>
                <p class="text-sm text-red-600">${order.allergies}</p>
              </div>
            ` : ''}
            
            ${order.specialInstructions ? `
              <div class="bg-yellow-50 rounded-lg p-3 border border-yellow-200">
                <p class="text-xs font-semibold text-yellow-700 mb-1">üìù SPECIAL INSTRUCTIONS</p>
                <p class="text-sm text-yellow-600">${order.specialInstructions}</p>
              </div>
            ` : ''}
          </div>
          
          <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
            <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 font-medium hover:bg-gray-200 transition-colors">
              Close
            </button>
            ${order.status === 'confirmed' ? `
              <button type="button" onclick="markOrderCompleted('${order.__backendId}'); closeModal();" class="px-4 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white font-medium transition-colors">
                Mark Complete
              </button>
            ` : ''}
          </div>
        </div>`;
      document.getElementById('modal-container').appendChild(modal);
    }

    async function markOrderCompleted(id) {
      if (!window.dataSdk) return;
      const order = allOrders.find(o => o.__backendId === id);
      if (!order) return;
      
      const result = await window.dataSdk.update({ ...order, status: 'completed' });
      if (result.isOk) {
        showToast('Order marked as completed!', 'success');
      } else {
        showToast('Failed to update order', 'error');
      }
    }

    async function deleteOrderMore(id) {
      if (!window.dataSdk) return;
      const order = allOrders.find(o => o.__backendId === id);
      if (!order) return;
      
      const result = await window.dataSdk.delete(order);
      if (result.isOk) {
        showToast('Order deleted successfully', 'success');
      } else {
        showToast('Failed to delete order', 'error');
      }
    }

    // Quick Add Order Modal
    

    

    async function addQuickOrder(e) {
  e.preventDefault();

  if (!window.dataSdk) return;

  if (allOrders.length >= 999) {
    showToast('Maximum limit of 999 orders reached', 'error');
    return;
  }

  const guestName = document.getElementById('quickGuestNameInput').value;
  const roomNumber = document.getElementById('quickRoomInput').value;
  const allergies = document.getElementById('quickAllergiesInput').value;
  const specialInstructions = document.getElementById('quickInstructionsInput').value;

  // Collect all items
  const itemFields = document.querySelectorAll('#itemsContainer > div');
  if (itemFields.length === 0) {
    showToast('Please add at least one item', 'error');
    return;
  }

  const items = [];
  let total = 0;

  itemFields.forEach((field) => {
    const name = field.querySelector('.item-name').value;
    const quantity = parseInt(field.querySelector('.item-qty').value) || 1;
    const price = parseFloat(field.querySelector('.item-price').value) || 0;

    if (name) {
      items.push({ name, qty: quantity, price });
      total += price * quantity;
    }
  });

  // ‚úÖ FIX: use items (not itemDetails)
  if (items.length === 0) {
    showToast('Please add at least one item with a name', 'error');
    return;
  }

  // ‚úÖ PASTE YOUR CODE EXACTLY HERE (orderData)
  const orderData = {
    type: 'order',
    orderId: String(Math.floor(Math.random() * 10000) + 1000),
    name: guestName, // matches Firestore field
    roomNumber,
    items,
    total,
    status: 'pending',
    contact: document.getElementById("quickContactInput")?.value || "",
    note: specialInstructions || "",
    allergies: allergies || "",            // (optional but you already collect it)
    createdAt: new Date().toISOString()    // optional; Firestore timestamp is added in createOrderFS
  };

  // ‚úÖ then create in Firestore
  const id = await window.createOrderFS(orderData);

  if (id) {
    closeModal();
    showToast('Order added successfully! üéâ', 'success');
  } else {
    showToast('Failed to add order', 'error');
  }
}

      
    

    // Menu Section with filtering
    let menuFilterCategory = '';
    let menuFilterDiet = '';
    
    function renderMenuSection(container) {
      let html = `
        <div class="animate-fade-in">
          <div class="mb-6 flex items-center justify-between">
            <div>
              <h2 class="text-2xl font-bold text-gray-900">Menu Management</h2>
              <p class="text-gray-500 text-sm mt-1">Add and manage menu items</p>
            </div>
            <button onclick="openAddMenuModal()" class="btn-primary px-4 py-2 rounded-xl text-white font-medium inline-flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Add Item
            </button>
          </div>
          
          <!-- Filters -->
          <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
              <select id="categoryFilter" onchange="filterMenuItems()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                <option value="">All Categories</option>
                <option value="Breakfast">Breakfast</option>
                <option value="Meal">Meal</option>
                <option value="Dinner">Dinner</option>
                <option value="Snacks">Snacks</option>
                <option value="Drinks & Beverages">Drinks & Beverages</option>
              </select>
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-2">Diet Type</label>
              <select id="dietFilter" onchange="filterMenuItems()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                <option value="">All Types</option>
                <option value="Veg">Veg</option>
                <option value="Non-Veg">Non-Veg</option>
              </select>
            </div>
            <div class="flex items-end">
              <button onclick="resetMenuFilters()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors">
                Reset Filters
              </button>
            </div>
          </div>`;
      
      const filteredItems = allMenuItems.filter(item => {
        const categoryMatch = !menuFilterCategory || item.category === menuFilterCategory;
        const dietMatch = !menuFilterDiet || item.dietType === menuFilterDiet;
        return categoryMatch && dietMatch;
      });
      
      if (allMenuItems.length === 0) {
        html += `
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
            <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-10 h-10 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">No menu items yet</h3>
            <p class="text-gray-500 mb-6">Add your first menu item to get started</p>
            <button onclick="openAddMenuModal()" class="btn-primary px-6 py-2 rounded-xl text-white font-medium inline-flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
              Add First Item
            </button>
          </div>`;
      } else if (filteredItems.length === 0) {
        html += `
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-900 mb-2">No items found</h3>
            <p class="text-gray-500 mb-6">Try adjusting your filters</p>
            <button onclick="resetMenuFilters()" class="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-medium">
              Clear Filters
            </button>
          </div>`;
      } else {
        html += `<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">`;
        filteredItems.forEach(item => {
          const dietIcon = item.dietType === 'Veg' 
            ? '<span class="w-4 h-4 border-2 border-green-600 bg-white flex items-center justify-center"><span class="w-2 h-2 bg-green-600 rounded-full"></span></span>'
            : '<span class="w-4 h-4 border-2 border-red-600 bg-white flex items-center justify-center"><span class="w-2 h-2 bg-red-600"></span></span>';
          
          html += `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 card-hover ${!item.isAvailable ? 'opacity-60' : ''}">
              <div class="flex items-start justify-between mb-3">
                <div class="flex items-center gap-2">
                  <span class="text-3xl">${item.emoji || 'üçΩÔ∏è'}</span>
                  <div>
                    <h3 class="font-semibold text-gray-900 text-lg">${item.name}</h3>
                    <div class="flex items-center gap-2 mt-1">
                      ${dietIcon}
                      <span class="text-xs text-gray-500">${item.category || ''}</span>
                    </div>
                  </div>
                </div>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${item.isAvailable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                  ${item.isAvailable ? 'Available' : 'Unavailable'}
                </span>
              </div>
              
              ${item.description ? `<p class="text-sm text-gray-600 mb-3">${item.description}</p>` : ''}
              
              <div class="flex items-center justify-between mb-3">
                <p class="text-2xl font-bold text-orange-500">‚Çπ${item.price}</p>
                <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full">${item.subcategory || ''}</span>
              </div>
              
              <div class="flex gap-2">
                <button onclick="toggleMenuAvailability('${item.__backendId}')" class="flex-1 px-3 py-2 rounded-lg ${item.isAvailable ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white text-sm font-medium transition-colors">
                  Mark ${item.isAvailable ? 'Unavailable' : 'Available'}
                </button>
                <button onclick="deleteMenuItem('${item.__backendId}')" class="px-3 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-medium transition-colors">
                  Delete
                </button>
              </div>
            </div>`;
        });
        html += `</div>`;
      }
      
      html += `</div>`;
      container.innerHTML = html;
    }

    function openAddMenuModal() {
      const foodEmojis = ['üçï', 'üçî', 'üçü', 'üå≠', 'ü•™', 'ÔøΩÔøΩÔøΩÔøΩ', 'ÔøΩÔøΩÔøΩÔøΩ', 'üåÆ', 'üåØ', 'ü•ô', 'üßÜ', 'üçù', 'üçú', 'üç≤', 'ü•ò', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'üç§', 'üçô', 'üçö', 'üçß', 'üç®', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞', 'üéÇ', 'üç©', 'üç™', 'üå∞', 'ü•ú', 'üçû', 'ü•ê', 'üçµ', 'ü•§', 'üç∂', 'üç∫', 'üçª', 'ü•Ç', 'üç∑', 'üç∏', 'üçπ', 'ü•É', 'ÔøΩÔøΩÔøΩÔøΩ', 'ü•†', 'ü•°', 'üßÄ', 'ü•õ', 'ü•ñ', 'ü•®', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ÔøΩÔøΩÔøΩ', 'ü•¨', 'ü•í', 'üåΩ', 'ü•ï', 'ÔøΩÔøΩ', 'ÔøΩÔøΩ', 'ü•î', 'üç†', 'ÔøΩÔøΩ', 'ÔøΩÔøΩ', '‚òï'];
      
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto';
      modal.innerHTML = `
        <div class="bg-white rounded-2xl p-6 w-full max-w-2xl animate-fade-in my-8">
          <h2 class="text-xl font-bold text-gray-900 mb-4">Add Menu Item</h2>
          <form onsubmit="addMenuItem(event)">
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
              <div>
                <label for="menuNameInput" class="block text-sm font-medium text-gray-700 mb-1">Item Name</label>
                <input id="menuNameInput" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="e.g., Margherita Pizza"/>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="menuCategoryInput" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                  <select id="menuCategoryInput" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="">Select Category</option>
                    <option value="Breakfast">Breakfast</option>
                    <option value="Meal">Meal</option>
                    <option value="Dinner">Dinner</option>
                    <option value="Snacks">Snacks</option>
                    <option value="Drinks & Beverages">Drinks & Beverages</option>
                  </select>
                </div>
                
                <div>
                  <label for="menuSubcategoryInput" class="block text-sm font-medium text-gray-700 mb-1">Subcategory</label>
                  <select id="menuSubcategoryInput" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                    <option value="">Select Subcategory</option>
                    <option value="Chinese">Chinese</option>
                    <option value="South Indian">South Indian</option>
                    <option value="Italian">Italian</option>
                    <option value="North Indian">North Indian</option>
                    <option value="Continental">Continental</option>
                    <option value="Mexican">Mexican</option>
                    <option value="Thai">Thai</option>
                    <option value="Japanese">Japanese</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label for="menuDietTypeInput" class="block text-sm font-medium text-gray-700 mb-2">Diet Type</label>
                <div class="flex gap-4">
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="dietType" value="Veg" required class="w-4 h-4 text-green-600 border-gray-300 focus:ring-green-500"/>
                    <span class="ml-2 text-sm text-gray-700 flex items-center gap-1">
                      <span class="w-4 h-4 border-2 border-green-600 bg-white flex items-center justify-center">
                        <span class="w-2 h-2 bg-green-600 rounded-full"></span>
                      </span>
                      Veg
                    </span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input type="radio" name="dietType" value="Non-Veg" required class="w-4 h-4 text-red-600 border-gray-300 focus:ring-red-500"/>
                    <span class="ml-2 text-sm text-gray-700 flex items-center gap-1">
                      <span class="w-4 h-4 border-2 border-red-600 bg-white flex items-center justify-center">
                        <span class="w-2 h-2 bg-red-600"></span>
                      </span>
                      Non-Veg
                    </span>
                  </label>
                </div>
              </div>
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label for="menuPriceInput" class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                  <div class="flex items-center border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-orange-500 focus-within:border-orange-500">
                    <span class="px-3 py-2 text-gray-700 font-medium">‚Çπ</span>
                    <input id="menuPriceInput" type="number" step="0.01" required class="flex-1 px-2 py-2 border-none focus:outline-none" placeholder="299"/>
                  </div>
                </div>
                
                <div>
                  <label for="menuEmojiInput" class="block text-sm font-medium text-gray-700 mb-1">Emoji</label>
                  <div class="relative">
                    <input id="menuEmojiInput" type="text" maxlength="2" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-2xl text-center cursor-pointer" placeholder="üçï" readonly onclick="toggleEmojiPicker()"/>
                    <div id="emojiPickerContainer" class="hidden absolute top-12 left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg p-3 z-10" style="max-height: 200px; overflow-y: auto;">
                      <div class="grid grid-cols-6 gap-2">
                        ${foodEmojis.map(emoji => `
                          <button type="button" onclick="selectEmoji('${emoji}')" class="text-2xl p-2 hover:bg-orange-100 rounded-lg transition-colors">
                            ${emoji}
                          </button>
                        `).join('')}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div>
                <label for="menuDescriptionInput" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea id="menuDescriptionInput" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Brief description of the item..."></textarea>
              </div>
              
              <div>
                <label class="flex items-center cursor-pointer">
                  <input type="checkbox" id="menuAvailabilityInput" checked class="w-4 h-4 text-orange-600 border-gray-300 rounded focus:ring-orange-500"/>
                  <span class="ml-2 text-sm font-medium text-gray-700">Available for order</span>
                </label>
              </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200">
              <button type="button" onclick="closeModal()" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700 font-medium hover:bg-gray-200 transition-colors">
                Cancel
              </button>
              <button type="submit" class="btn-primary px-4 py-2 rounded-lg text-white font-medium">
                Add Item
              </button>
            </div>
          </form>
        </div>`;
      document.getElementById('modal-container').appendChild(modal);
      document.getElementById('menuEmojiInput').value = 'üçΩÔ∏è';
    }
    
    function toggleEmojiPicker() {
      const picker = document.getElementById('emojiPickerContainer');
      picker.classList.toggle('hidden');
    }
    
    function selectEmoji(emoji) {
      document.getElementById('menuEmojiInput').value = emoji;
      document.getElementById('emojiPickerContainer').classList.add('hidden');
    }
    
    function filterMenuItems() {
      menuFilterCategory = document.getElementById('categoryFilter').value;
      menuFilterDiet = document.getElementById('dietFilter').value;
      renderMenuSection(document.getElementById('main-content'));
    }
    
    function resetMenuFilters() {
      menuFilterCategory = '';
      menuFilterDiet = '';
      document.getElementById('categoryFilter').value = '';
      document.getElementById('dietFilter').value = '';
      renderMenuSection(document.getElementById('main-content'));
    }

    async function addMenuItem(e) {
      e.preventDefault();
      
      if (!window.dataSdk) return;
      
      if (allMenuItems.length >= 999) {
        showToast('Maximum limit of 999 items reached', 'error');
        return;
      }
      
      const name = document.getElementById('menuNameInput').value;
      const category = document.getElementById('menuCategoryInput').value;
      const subcategory = document.getElementById('menuSubcategoryInput').value;
      const dietType = document.querySelector('input[name="dietType"]:checked').value;
      const price = Number(document.getElementById('menuPriceInput').value);
      const emoji = document.getElementById('menuEmojiInput').value || 'üçΩÔ∏è';
      const description = document.getElementById('menuDescriptionInput').value;
      const isAvailable = document.getElementById('menuAvailabilityInput').checked;
      
      const menuData = {
        type: 'menuItem',
        name,
        category,
        subcategory,
        dietType,
        price,
        emoji,
        description,
        isAvailable,
        isSpecial: false,
        createdAt: new Date().toISOString()
      };
      
      const result = await window.dataSdk.create(menuData);
      
      if (result.isOk) {
        closeModal();
        showToast('Menu item added successfully!', 'success');
      } else {
        showToast('Failed to add menu item', 'error');
      }
    }

    async function toggleMenuAvailability(id) {
      if (!window.dataSdk) return;
      const item = allMenuItems.find(i => i.__backendId === id);
      if (!item) return;
      
      const result = await window.dataSdk.update({ ...item, isAvailable: !item.isAvailable });
      if (result.isOk) {
        showToast(item.isAvailable ? 'Marked as unavailable' : 'Marked as available', 'success');
      } else {
        showToast('Failed to update item', 'error');
      }
    }

    async function deleteMenuItem(id) {
      if (!window.dataSdk) return;
      const item = allMenuItems.find(i => i.__backendId === id);
      if (!item) return;
      
      const result = await window.dataSdk.delete(item);
      if (result.isOk) {
        showToast('Menu item deleted successfully', 'success');
      } else {
        showToast('Failed to delete item', 'error');
      }
    }

    // Analytics Section
    // Analytics Section (‚úÖ FIXED)
function renderAnalyticsSection(container) {
  // Use Firestore as source of truth
  const fsOrders = Array.isArray(window.latestKitchenOrders) ? window.latestKitchenOrders : [];

  const totalOrders = fsOrders.length;
  const pendingOrders = fsOrders.filter(o => (o.status || "").toLowerCase() === "pending").length;
  const confirmedOrders = fsOrders.filter(o => (o.status || "").toLowerCase() === "confirmed").length;
  const completedOrders = fsOrders.filter(o => (o.status || "").toLowerCase() === "completed").length;

  const totalMenuItems = allMenuItems.length;
  const availableItems = allMenuItems.filter(i => i.isAvailable).length;

  container.innerHTML = `
    <div class="animate-fade-in">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Analytics</h2>
        <p class="text-gray-500 text-sm mt-1">Overview of your restaurant operations</p>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
        <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-2xl p-6 border border-blue-200">
          <p class="text-3xl font-bold text-gray-900 mb-1">${totalOrders}</p>
          <p class="text-sm text-gray-600">Total Orders</p>
        </div>

        <div class="bg-gradient-to-br from-red-50 to-red-100 rounded-2xl p-6 border border-red-200">
          <p class="text-3xl font-bold text-gray-900 mb-1">${pendingOrders}</p>
          <p class="text-sm text-gray-600">Pending (Kitchen)</p>
        </div>

        <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-2xl p-6 border border-yellow-200">
          <p class="text-3xl font-bold text-gray-900 mb-1">${confirmedOrders}</p>
          <p class="text-sm text-gray-600">Confirmed</p>
        </div>

        <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-2xl p-6 border border-green-200">
          <p class="text-3xl font-bold text-gray-900 mb-1">${completedOrders}</p>
          <p class="text-sm text-gray-600">Completed Orders</p>
        </div>

        <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-2xl p-6 border border-purple-200">
          <p class="text-3xl font-bold text-gray-900 mb-1">${totalMenuItems}</p>
          <p class="text-sm text-gray-600">Menu Items</p>
        </div>

        <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl p-6 border border-orange-200">
          <p class="text-3xl font-bold text-gray-900 mb-1">${availableItems}</p>
          <p class="text-sm text-gray-600">Available Items</p>
        </div>
      </div>
    </div>
  `;
}


    // Payment Section
    function renderPaymentSection(container) {
      container.innerHTML = `
        <div class="animate-fade-in">
          <div class="mb-6">
            <h2 class="text-2xl font-bold text-gray-900">Payment & Subscription</h2>
            <p class="text-gray-500 text-sm mt-1">Manage your subscription and billing</p>
          </div>
          
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-bold text-gray-900">Monthly Plan</h3>
                  <p class="text-sm text-gray-500">Billed monthly</p>
                </div>
              </div>
              <div class="mb-4">
                <p class="text-4xl font-bold text-gray-900 mb-2">‚Çπ5,000<span class="text-lg font-normal text-gray-500">/month</span></p>
                <p class="text-sm text-gray-600">Perfect for getting started</p>
              </div>
              <button onclick="processPayment('monthly')" class="w-full btn-primary px-4 py-3 rounded-xl text-white font-medium">
                Subscribe Monthly
              </button>
            </div>
            
            <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-2xl border-2 border-orange-300 p-6 relative overflow-hidden">
              <div class="absolute top-4 right-4 bg-orange-500 text-white text-xs font-bold px-3 py-1 rounded-full">
                SAVE 15%
              </div>
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center">
                  <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <div>
                  <h3 class="font-bold text-gray-900">Yearly Plan</h3>
                  <p class="text-sm text-gray-600">Billed annually</p>
                </div>
              </div>
              <div class="mb-4">
                <p class="text-4xl font-bold text-gray-900 mb-2">‚Çπ51,000<span class="text-lg font-normal text-gray-600">/year</span></p>
                <p class="text-sm text-gray-600">Save ‚Çπ9,000 annually</p>
              </div>
              <button onclick="processPayment('yearly')" class="w-full bg-orange-600 hover:bg-orange-700 px-4 py-3 rounded-xl text-white font-medium transition-colors">
                Subscribe Yearly
              </button>
            </div>
          </div>
          
          <div class="mt-6 bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
            <h3 class="font-bold text-gray-900 mb-4">AutoPay Settings</h3>
            <div class="flex items-center justify-between">
              <div class="flex items-start gap-3">
                <input type="checkbox" id="autopayCheckbox" class="mt-1 w-5 h-5 text-orange-600 border-gray-300 rounded focus:ring-orange-500"/>
                <label for="autopayCheckbox" class="cursor-pointer">
                  <p class="font-medium text-gray-900">Enable AutoPay</p>
                  <p class="text-sm text-gray-500">Automatically renew your subscription</p>
                </label>
              </div>
            </div>
          </div>
        </div>`;
    }

    function processPayment(plan) {
      const amount = plan === 'monthly' ? '‚Çπ5,000' : 'ÔøΩÔøΩ54,000';
      const period = plan === 'monthly' ? 'Monthly' : 'Yearly';
      showToast(`${period} payment of ${amount} processed successfully!`, 'success');
    }

    // Modal functions
    function closeModal() {
      document.getElementById('modal-container').innerHTML = '';
    }
    
// ‚úÖ FINAL & ONLY View Order Modal (Firestore)
function openOrderDetailsFS(orderId) {
  const orders = Array.isArray(window.latestKitchenOrders)
    ? window.latestKitchenOrders
    : [];

  const order = orders.find(o => o.id === orderId);
  if (!order) {
    alert("Order not found");
    return;
  }

  const items = window.normalizeItems(order);
  const total = window.normalizeTotal(order);

  const itemsHtml = items.length
    ? `<ul class="ml-5 list-disc text-sm text-gray-700">
        ${items.map(i => `<li>${i.name} √ó ${i.qty}</li>`).join("")}
      </ul>`
    : `<p class="text-sm text-gray-600">No items</p>`;

  const modal = document.createElement("div");
  modal.className =
    "fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4";

  modal.innerHTML = `
    <div class="bg-white rounded-2xl p-6 w-full max-w-md animate-fade-in">
      <div class="mb-4">
        <h2 class="text-xl font-bold text-gray-900">
          ${window.getCustomerName(order)} ‚Äì Room ${window.getRoom(order)}
        </h2>
        <p class="text-sm text-gray-500">Order ID: ${order.orderId || order.id}</p>
      </div>

      <div class="space-y-3 mb-4 max-h-[40vh] overflow-y-auto">
        <h3 class="font-semibold text-gray-900">Order Items</h3>
        ${itemsHtml}
        <p class="text-sm text-gray-600 mt-2">
          <b>Note:</b> ${order.note || "None"}
        </p>
      </div>

      <p class="text-sm font-semibold text-orange-600 mb-4">
        Total: ‚Çπ${total.toFixed(2)}
      </p>

      <div class="flex justify-end">
        <button
          onclick="closeModal()"
          class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 font-medium"
        >
          Close
        </button>
      </div>
    </div>
  `;

  document.getElementById("modal-container").appendChild(modal);
}


    // Toast notification
    function showToast(message, type = 'info') {
      const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500'
      };
      
      const toast = document.createElement('div');
      toast.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-3 animate-fade-in`;
      toast.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <span>${message}</span>`;
      
      const container = document.getElementById('toast-container');
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Initialize
    async function initialize() {
      applyConfig();
      initElementSdk();
      await initDataSdk();
      window.renderSection('home');
      
    }
    
    initialize();
    function renderOrdersMoreSection(container) {
  const all = Array.isArray(window.latestKitchenOrders) ? window.latestKitchenOrders : [];

  const confirmed = all.filter(o => (o.status || "").toLowerCase() === "confirmed");
  const completed = all.filter(o => (o.status || "").toLowerCase() === "completed");

  container.innerHTML = `
    <div class="animate-fade-in">
      <div class="mb-6">
        <h2 class="text-2xl font-bold text-gray-900">Orders</h2>
        <p class="text-gray-500 text-sm mt-1">Confirmed orders (from Kitchen) appear here</p>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-4">
          <h3 class="font-bold text-gray-900 mb-3">‚úÖ Confirmed</h3>
          <div id="orders-confirmed-list" class="space-y-3"></div>
        </div>

        <div class="bg-white rounded-2xl border border-gray-100 shadow-sm p-4">
          <h3 class="font-bold text-gray-900 mb-3">üèÅ Completed</h3>
          <div id="orders-completed-list" class="space-y-3"></div>
        </div>
      </div>
    </div>
  `;

  renderOrdersList("orders-confirmed-list", confirmed, "confirmed");
  renderOrdersList("orders-completed-list", completed, "completed");
}

function renderOrdersList(targetId, list, type) {
  const el = document.getElementById(targetId);
  if (!el) return;

  if (!list.length) {
    el.innerHTML = `<p class="text-sm text-gray-500">No ${type} orders</p>`;
    return;
  }

  // newest first (if createdAt is Firestore Timestamp)
  list.sort((a, b) => {
    const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
    const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
    return tb - ta;
  });

  el.innerHTML = list.map(order => {
    const items = normalizeItems(order);
    const total = normalizeTotal(order);

    return `
      <div class="border border-gray-100 rounded-xl p-4 bg-gray-50">
        <div class="flex items-start justify-between">
          <div>
            <p class="font-semibold text-gray-900">${getCustomerName(order)}</p>
            <p class="text-sm text-gray-600">Room ${getRoom(order)}</p>
          </div>
          <span class="text-xs font-semibold px-2 py-1 rounded-full ${
            type === "confirmed"
              ? "bg-orange-100 text-orange-700"
              : "bg-green-100 text-green-700"
          }">
            ${type.toUpperCase()}
          </span>
        </div>

        <div class="mt-2">
          ${
            items.length
              ? `<ul class="ml-5 list-disc text-sm text-gray-700">
                  ${items.map(i => `<li>${i.name} √ó ${i.qty}</li>`).join("")}
                </ul>`
              : `<p class="text-sm text-gray-600">${order.items || "No items"}</p>`
          }
        </div>

        <p class="text-sm font-semibold text-orange-600 mt-2">Total: ‚Çπ${total.toFixed(2)}</p>

        <div class="mt-3 flex gap-2">
          <button
            onclick="openOrderDetailsFS('${order.id}')"
            class="flex-1 px-3 py-2 rounded-lg bg-white border border-gray-200 hover:bg-gray-100 text-sm font-medium"
          >
            View
          </button>

          ${
            type === "confirmed"
              ? `<button
                  onclick="completeOrderFS('${order.id}')"
                  class="flex-1 px-3 py-2 rounded-lg bg-green-500 hover:bg-green-600 text-white text-sm font-semibold"
                >
                  Mark Complete
                </button>`
              : ""
          }

          <button
            onclick="deleteOrderFS('${order.id}')"
            class="px-3 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm font-semibold"
            title="Delete"
          >
            üóëÔ∏è
          </button>
        </div>
      </div>
    `;
  }).join("");
}

  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c84b26a516b465e',t:'MTc3MDE1MDc0MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>